const express = require('express')
const router = express.Router()
const db = require('../model/db.js')
const connect = require('connect-ensure-login')

/**
 * POST Bid creation
 *
 * User bids for the Car Ride
 * The Car Ride entity is identified by the following composite key
 * (driver, date, time, origin, destination)
 * The bid created has the following information to be submitted
 * P_Key (bidder, driver, date, time, origin, destination)
 * others:
 * bidAmount
 * autogenerated information: bidstatus = 'pending'
 */
router.post('/create', connect.ensureLoggedIn('/login'), async function(
  req,
  res,
  next
) {
  const primary_key = {
    bidder: req.body.bidder_field,
    driver: req.body.driver_field,
    date: req.body.date_field,
    time: req.body.time_field,
    origin: req.body.origin_field,
    destination: req.body.destination_field,
  }

  await db.bid.createUserBid(
    primary_key.bidder,
    req.body.bid_amount_field,
    primary_key.driver,
    primary_key.date,
    primary_key.time,
    primary_key.origin,
    primary_key.destination,
    db.exposedInstance
  )

  res.redirect(`/rider`)
})

/**
 * POST Bid update
 *
 * User bids for the Car Ride
 * The Car Ride entity is identified by the following composite key
 * (driver, date, time, origin, destination)
 * The bid created has the following information to be submitted
 * P_Key (bidder, driver, date, time, origin, destination)
 * others:
 * bidAmount
 * autogenerated information: bidstatus = 'pending'
 */
router.post('/update', connect.ensureLoggedIn('/login'), async function(
  req,
  res,
  next
) {
  // Current date returned is in UTCString format (???) PGSQL cannot accept this
  // Instead, we convert this to a generic LocaleDateString
  const sanitized_date = new Date(req.body.date_field).toLocaleDateString()

  const primary_key = {
    bidder: req.body.bidder_field,
    driver: req.body.driver_field,
    date: sanitized_date,
    time: req.body.time_field,
    origin: req.body.origin_field,
    destination: req.body.destination_field,
  }

  await db.bid.updateUserBid(
    primary_key.bidder,
    req.body.bid_amount_field,
    primary_key.driver,
    primary_key.date,
    primary_key.time,
    primary_key.origin,
    primary_key.destination,
    db.exposedInstance
  )

  res.redirect(`/rider`)
})

router.post('/delete', async function(req, res, next) {
  // Current date returned is in UTCString format (???) PGSQL cannot accept this
  // Instead, we convert this to a generic LocaleDateString
  const sanitized_date = new Date(req.body.date_field).toLocaleDateString()

  const primary_key = {
    bidder: req.body.bidder_field,
    driver: req.body.driver_field,
    date: sanitized_date,
    time: req.body.time_field,
    origin: req.body.origin_field,
    destination: req.body.destination_field,
  }

  await db.bid.deleteUserBid(
    primary_key.bidder,
    primary_key.driver,
    primary_key.date,
    primary_key.time,
    primary_key.origin,
    primary_key.destination,
    db.exposedInstance
  )

  res.redirect(`/rider`)
})

module.exports = router
